ORDER BY in Window Functions
================

## ORDER BY

  - `ORDER BY` is a subclause of `OVER`
  - It orders the rows related to the current row that the window
    function will use.

<!-- end list -->

``` sql
SELECT
  Year,
  -- Assign the lowest numbers to the most recent years
  ROW_NUMBER() OVER (ORDER BY Year DESC) AS Row_N
FROM (
  SELECT DISTINCT Year
  FROM Summer_Medals
) AS Years
ORDER BY Year;
```

## Reigning champion

  - One of the applications of window functions is determining reigning
    champion status. A reigning champion is a champion who’s **won both
    the previous and current years’ competitions**. To determine if a
    champion is a reigning champion, the previous and the current years’
    champions need to be in the same row, in two different columns, so
    that they can be compared. How can you get a previous row’s value
    without complex self-joins?

  - Enter `LAG`. `LAG` is a window function that takes a column and a
    number n and returns the column’s value n rows before the current
    row. Passing 1 as n returns the previous row’s value.

### CTE (Common Table Expressions)

  - `WITH` provides a way to write auxiliary statements for use in a
    larger query. These statements, which are often referred to as
    Common Table Expressions or **CTEs**, can be thought of as defining
    temporary tables that exist just for one query. (**JUST FOR ONE\!**)

  - Having wrapped the previous query in the `Athlete_Medals` `CTE`,
    rank each athlete by the number of medals they’ve earned.

<!-- end list -->

``` sql
WITH Athlete_Medals AS (
  SELECT
    -- Count the number of medals each athlete has earned
    Athlete,
    COUNT(*) AS Medals
  FROM Summer_Medals
  GROUP BY Athlete)

SELECT
  -- Number each athlete by how many medals they've earned
  Athlete,
  ROW_NUMBER() OVER (ORDER BY Medals DESC) AS Row_N
FROM Athlete_Medals
ORDER BY Medals DESC;
```

  - \*\*Difference between `WITH` and `TEMP TABLE`\*

  - \-\> Mostly a **memory** problem\! \<3

  - The main difference is that the temporary table is a stored table. A
    CTE is more akin to a *view*, and helps you express your SQL in an
    easier to read, more logical way. The same differences apply between
    tables and views in that a table gives you the potential to do
    things in a performant way.

  - While `TEMP` table is **transient** only for the current session,
    `WITH` is always re-evaluated.

### Reigning weightlifting champions

  - A reigning champion is a champion who’s won both the previous and
    current years’ competitions. To determine if a champion is reigning,
    the previous and current years’ results need to be in the same row,
    in two different columns.

  - Return each year’s gold medalists in the Men’s 69KG weightlifting
    competition.

<!-- end list -->

``` sql
SELECT
 -- Return each year's champions' countries
 Year,
 Country AS champion
FROM Summer_Medals
WHERE
 Discipline = 'Weightlifting' AND
 Event = '69KG' AND
 Gender = 'Men' AND
 Medal = 'Gold';
```

  - Having wrapped the previous query in the Weightlifting\_Gold
    **CTE**, get the previous year’s champion for each year.

### `LAG`

  - 
<!-- end list -->

``` sql

-- This is basically like using a 
-- temporary table - with memory problems:

WITH Weightlifting_Gold AS (
  SELECT
    -- Return each year's champions' countries
    Year,
    Country AS champion
  FROM Summer_Medals
  WHERE
    Discipline = 'Weightlifting' AND
    Event = '69KG' AND
    Gender = 'Men' AND
    Medal = 'Gold')

SELECT
  Year, Champion,
  -- Fetch the previous year's champion
  LAG(Champion) OVER
    (ORDER BY Year ASC) AS Last_Champion
FROM Weightlifting_Gold
ORDER BY Year ASC;
```

### `PARTITION BY`

  -
